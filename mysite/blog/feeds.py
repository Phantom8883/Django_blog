# ============================================
# СОЗДАНИЕ НОВОСТНЫХ ЛЕНТ (RSS FEEDS) ДЛЯ БЛОГА
# ============================================
#
# ЧТО ТАКОЕ RSS ЛЕНТА?
# --------------------
# RSS (Really Simple Syndication) - это формат данных (обычно XML),
# который предоставляет пользователям самый последний обновленный контент.
# Пользователи могут подписываться на новостную ленту с помощью агрегатора
# новостных лент (программного обеспечения для чтения новостных лент).
#
# ЗАЧЕМ НУЖНА RSS ЛЕНТА?
# ----------------------
# 1. Пользователи могут подписаться на твой блог
# 2. Получать уведомления о новых постах
# 3. Читать посты в специальных программах (RSS-ридеры)
# 4. Не нужно каждый раз заходить на сайт - посты приходят автоматически
#
# КАК ЭТО РАБОТАЕТ?
# -----------------
# 1. Django генерирует XML-файл с последними постами
# 2. Пользователь подписывается на этот XML-файл (URL)
# 3. RSS-ридер периодически проверяет этот файл
# 4. Когда появляется новый пост - пользователь получает уведомление
#
# ПРИМЕР RSS-РИДЕРОВ:
# - Fluent Reader (десктоп)
# - Feedly (веб)
# - Inoreader (веб)
# - И многие другие

import markdown
from django.contrib.syndication.views import Feed
from django.template.defaultfilters import truncatewords_html
from django.urls import reverse_lazy
from .models import Post


# ============================================
# КЛАСС LatestPostsFeed - НОВОСТНАЯ ЛЕНТА
# ============================================
#
# Этот класс наследуется от Feed - встроенного класса Django для создания RSS лент.
# Django автоматически преобразует этот класс в XML-файл RSS формата.
#
# АТРИБУТЫ КЛАССА (метаданные ленты):
# ------------------------------------
# title - название ленты (отображается в RSS-ридере)
# link - ссылка на главную страницу блога
# description - описание ленты (что это за лента)
#
# МЕТОДЫ КЛАССА (данные постов):
# -------------------------------
# items() - возвращает список постов для ленты
# item_title() - заголовок каждого поста
# item_description() - описание/содержимое каждого поста
# item_pubdate() - дата публикации каждого поста

class LatestPostsFeed(Feed):
    # ============================================
    # МЕТАДАННЫЕ ЛЕНТЫ (информация о самой ленте)
    # ============================================
    
    # Название ленты - отображается в RSS-ридере
    # Пример: "My blog" будет видно в списке подписок
    title = 'My blog'
    
    # Ссылка на главную страницу блога
    # reverse_lazy() - ленивая версия reverse() (генерирует URL до загрузки конфигурации)
    # 'blog:post_list' - имя URL-маршрута из urls.py
    # Зачем lazy? Потому что URL-конфигурация может быть еще не загружена
    link = reverse_lazy('blog:post_list')
    
    # Описание ленты - что это за лента, для чего она нужна
    # Отображается в RSS-ридере при подписке
    description = 'New posts of my blog.'

    # ============================================
    # МЕТОДЫ ДЛЯ ПОЛУЧЕНИЯ ДАННЫХ ПОСТОВ
    # ============================================
    
    def items(self):
        """
        Возвращает список постов, которые будут включены в RSS ленту.
        
        Что делает:
        - Получает все опубликованные посты (Post.published)
        - Ограничивает до 5 последних постов [:5]
        - Возвращает QuerySet постов
        
        Зачем ограничение?
        - RSS лента не должна быть слишком длинной
        - Обычно показывают последние 5-10 постов
        - Пользователь может прочитать старые посты на сайте
        """
        return Post.published.all()[:5]

    def item_title(self, item):
        """
        Возвращает заголовок поста для RSS ленты.
        
        Параметры:
        - item - объект Post (один пост из списка items())
        
        Что возвращает:
        - Заголовок поста (item.title)
        
        Зачем нужен этот метод?
        - Django автоматически вызывает его для каждого поста
        - Можно кастомизировать заголовок (например, добавить префикс)
        """
        return item.title

    def item_description(self, item):
        """
        Возвращает описание/содержимое поста для RSS ленты.
        
        Параметры:
        - item - объект Post
        
        Что делает:
        1. markdown.markdown(item.body) - конвертирует Markdown в HTML
            (пост может быть написан в формате Markdown)
        2. truncatewords_html(..., 30) - обрезает до 30 слов, избегая незакрытых HTML-тегов
            (не показываем весь пост, только превью)
        
        Что возвращает:
        - HTML-код с первыми 30 словами поста
        
        Зачем truncatewords_html, а не truncatewords?
        - truncatewords_html правильно обрабатывает HTML-теги
        - Не обрезает теги посередине (например, не оставит <p> без </p>)
        - Безопаснее для HTML-разметки
        """
        return truncatewords_html(markdown.markdown(item.body), 30)

    def item_pubdate(self, item):
        """
        Возвращает дату публикации поста.
        
        Параметры:
        - item - объект Post
        
        Что возвращает:
        - Дата публикации (item.publish)
        
        Зачем нужен этот метод?
        - RSS-ридеры показывают дату публикации
        - Пользователи видят, когда был опубликован пост
        - Можно сортировать посты по дате
        """
        return item.publish

